{% extends '@admin/base.html.twig' %}

{% block title %}
	{{ 'signature.title'|trans() }}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="{{asset('css/jquery-ui.min.css')}}">
	<style>
		.container {
			max-width: 600px;
			margin: 50px auto;
			padding: 20px;
			border: 1px solid #ddd;
			border-radius: 8px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			background-color: #fff;
		}
		h1 {
			text-align: center;
			margin-bottom: 20px;
			color: #333;
		}
		.signature-pad {
			border: 1px solid #ccc;
			border-radius: 4px;
			padding: 10px;
			background-color: #f9f9f9;
			margin-bottom: 20px;
			width: 100%;
			height: 300px; /* Ajustez la hauteur selon vos besoins */
		}
		.signature-pad--body {
			border: 1px solid #ddd;
			border-radius: 4px;
			background-color: #fff;
			padding: 10px;
			width: 100%;
			height: 100%;
		}
		canvas {
			border: 1px solid #ddd;
			border-radius: 4px;
			background-color: #fff;
			width: 100%;
			height: 100%;
		}
		.btn {
			margin-right: 10px;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container">
		<h1>{{ 'signature.title'|trans() }}</h1>
		<form id="signature-form" method="POST" action="{{ path('app_user_contract_signature_save', {loanNumber: loanNumber, type: type}) }}" enctype="multipart/form-data">
			<div>
				<label for="signature-pad">{{ 'signature.label'|trans() }}</label>
				<div id="signature-pad" class="signature-pad">
					<div id="canvas-wrapper" class="signature-pad--body">
						<canvas></canvas>
					</div>
				</div>
			</div>
			<div>
				<button type="button" id="clear-signature" class="btn btn-secondary">{{ 'signature.clear'|trans() }}</button>
				<button type="submit" id="save-signature" class="btn btn-primary">{{ 'signature.save'|trans() }}</button>
			</div>
		</form>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="{{asset('js/jquery-ui.min.js')}}"></script>
	<script src="{{asset('js/signature_pad.umd.min.js')}}"></script>
	<script>
		$(document).ready(function () {
			const wrapper = document.getElementById("signature-pad");
			const canvasWrapper = document.getElementById("canvas-wrapper");
			const canvas = wrapper.querySelector("canvas");

			// Ajustez la taille du canvas pour qu'il prenne tout l'espace disponible
			canvas.width = canvasWrapper.clientWidth;
			canvas.height = canvasWrapper.clientHeight;

			const signaturePad = new SignaturePad(canvas, {
				penColor: 'rgba(0, 0, 0, 1)', // Couleur du stylo plus claire
				backgroundColor: 'rgb(255, 255, 255)', // Couleur de fond
				minWidth: 0.5, // Largeur minimale du trait
				maxWidth: 0.9 // Largeur maximale du trait
			});

			$('#clear-signature').click(function () {
				signaturePad.clear();
			});

			$('#signature-form').submit(function (event) {
				event.preventDefault();
				if (signaturePad.isEmpty()) {
					swal("{{ 'signature.error.empty'|trans() }}", "", "error");
					return;
				}

				var dataURL = signaturePad.toDataURL();
				var formData = new FormData(this);
				var blob = dataURLtoBlob(dataURL);
				formData.append('file', blob, 'signature.png');

				$.ajax({
					url: $('#signature-form').attr('action'),
					type: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function (response) {
						swal("{{ 'signature.success'|trans() }}", "", "success");
						window.location.href = response["urlList"];
					},
					error: function (xhr, status, error) {
						swal("{{ 'signature.error.submit'|trans() }}", "", "error");
					}
				});
			});

			function dataURLtoBlob(dataURL) {
				var arr = dataURL.split(','),
					mime = arr[0].match(/:(.*?);/)[1],
					bstr = atob(arr[1]),
					n = bstr.length,
					u8arr = new Uint8Array(n);
				while (n--) {
					u8arr[n] = bstr.charCodeAt(n);
				}
				return new Blob([u8arr], {type: mime});
			}
		});
	</script>
{% endblock %}